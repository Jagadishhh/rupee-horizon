(function(){"use strict";new Date().toLocaleDateString("en-IN",{day:"numeric",month:"short",year:"numeric"});const B={MAX_AGE:90},V=(e,n=1)=>{const m=e<0,c=Math.abs(e);let a="";return c<1e5?a="₹"+new Intl.NumberFormat("en-IN",{maximumFractionDigits:0}).format(c):c<1e7?a="₹"+(c/1e5).toFixed(n)+" L":a="₹"+(c/1e7).toFixed(n)+" Cr",m?"-"+a:a},oe=e=>{const n=Math.sin(e)*1e4;return n-Math.floor(n)},g=(e,n,m=!1)=>{const{currentAge:c,retirementAge:a,currentSavings:M,monthlyIncome:I,monthlyExpenses:S,stepUpSIP:$}=e,C=new Date().getFullYear(),D=Math.max(0,a-c);let l=e.expectedReturn,f=e.expectedReturnPostRet,o=e.inflation,d=Math.max(5,e.inflation-.5),P=9;n==="best"?(l+=2,f+=1.5,o-=1,d=Math.max(4,d-1),P=7):n==="worst"&&(l-=3,f-=2,o+=1.5,d+=1.5,P=10);const T=Math.max(0,I-S)*12,b=Math.pow(1+o/100,D),p=S*b*12,G=B.MAX_AGE,Q=Math.max(1,G-a),ie=f/100,ce=d/100,F=(1+ie)/(1+ce)-1;let R=0;Math.abs(F)<.001?R=p*Q:R=p*((1-Math.pow(1+F,-Q))/F)*(1+F);const le=R>0?p/R:0,L=[];let h=M,v=T,j=p;const fe=12;let W=null;for(let s=c;s<=B.MAX_AGE;s++){const te=C+(s-c),E=s<a,w=s-a;let t="",ne=!1,se=E?l:f;if(!E){let A=f;s>=75&&s<85?(A=f-1,s===75&&(t=(t?t+". ":"")+"Portfolio De-risking")):s>=85&&(A=Math.max(4,f-2.5),s===85&&(t=(t?t+". ":"")+"Max Conservation"));let r=A;if(w<=10){const i=te*1337,N=oe(i)*6-3;n!=="median"?r+=N:r+=N*.5,n==="worst"&&(w===0?(r=-25,t=(t?t+". ":"")+"MARKET CRASH (-25%)"):w===1&&(r=-5,t=(t?t+". ":"")+"Bear Market")),n==="best"&&w<5&&(r=Math.max(r,12),w===0&&(t=(t?t+". ":"")+"Bull Run Start"))}se=r}const k=h<0?fe:se,y=Math.pow(1+k/100,1/12)-1;if(!m){const A=e.majorExpenses.filter(i=>i.purchaseAge===s);let u=0;const r=[];if(A.forEach(i=>{const N=i.purchaseAge-e.currentAge,ae=i.currentCost*Math.pow(1+i.inflationRate/100,N);u+=ae,r.push(`${i.name} (${V(ae,1)})`)}),u>0){h-=u,h<0&&(ne=!0,t=`⚠️ DEFICIT: Debt of ${V(Math.abs(h),1)}`);const i=r.join(", ");t=t?`${t}. Expense: ${i}`:`Expense: ${i}`}}h<0&&W===null&&(W=s,t.includes("DEFICIT")||(t=(t?t+". ":"")+"Funds Depleted"));let z="Accumulation";h<0?z=E?"Deficit":"Depleted":E||(z=w===0?"Transition":"Decumulation");let K=0;if(E){const u=v/12*((Math.pow(1+y,12)-1)/y)*(1+y);K=v,h=h*(1+k/100)+u,v=v*(1+$/100)}else{const u=j/12*((Math.pow(1+y,12)-1)/y)*(1+y);K=-j,h=h*(1+k/100)-u;let r=0;s>=60&&(r=Math.min(.6,.2+(s-60)*.01));const i=(1-r)*d+r*P;j=j*(1+i/100)}L.push({year:te,age:s,phase:z,cashflow:K,corpus:h,returnApplied:k,inflationApplied:E?o:0,note:t,isUnaffordable:ne})}const x=W!==null?W-1:B.MAX_AGE,Z=L.find(s=>s.age===a),ee=Z?Z.corpus:0,he=Math.max(0,R-ee),me=Math.max(0,x-a);let X="Base Plan",Y="ring-brand-500/20",H="#2563eb",O="rgba(37, 99, 235, 0.1)",U="Balanced assumptions.",q=x>=90?"safe":x>80?"risk":"critical";return n==="best"?(X="Optimistic",Y="ring-emerald-500/20",H="#10b981",O="rgba(16, 185, 129, 0.1)",U="High returns, low inflation.",q=x>=95?"safe":"risk"):n==="worst"&&(X="Pessimistic",Y="ring-rose-500/20",H="#f43f5e",O="rgba(244, 63, 94, 0.1)",U="Early crash, high inflation.",q=x>=85?"safe":"critical"),{title:X,requiredCorpus:R,projectedCorpus:ee,shortfall:he,yearsLasting:me,finalAge:x,data:L,swr:le,colorClass:Y,strokeColor:H,fillColor:O,description:U,status:q}},re=e=>{const n=e.retirementAge-e.currentAge,m=Math.max(0,e.monthlyIncome-e.monthlyExpenses),c=e.monthlyExpenses*Math.pow(1+e.inflation/100,n),a=g(e,"median"),M=g(e,"best"),I=g(e,"worst"),S={median:g(e,"median",!0),best:g(e,"best",!0),worst:g(e,"worst",!0)},$=["median","best","worst"],C={median:[],best:[],worst:[]};let D=0;return e.majorExpenses.forEach(l=>{const f=l.purchaseAge-e.currentAge,o=l.currentCost*Math.pow(1+l.inflationRate/100,f);D+=o}),$.forEach(l=>{const f=l==="median"?a:l==="best"?M:I;C[l]=e.majorExpenses.map(o=>{const d={...e,majorExpenses:e.majorExpenses.filter(G=>G.id!==o.id)},_=g(d,l).finalAge,T=f.finalAge,b=_-T,J=o.purchaseAge-e.currentAge,p=o.currentCost*Math.pow(1+o.inflationRate/100,J);return{expenseId:o.id,name:o.name,originalAge:o.purchaseAge,currentFinalAge:T,improvedFinalAge:_,yearsLost:b,status:b>5?"critical":b>0?"caution":"safe",costAtPurchase:p}})}),{yearsToRetirement:n,monthlySavings:m,monthlyExpenseAtRetirement:c,annualExpenseAtRetirement:c*12,median:a,best:M,worst:I,baselines:S,optimizations:C,totalMajorExpensesCost:D}};self.onmessage=e=>{const n=e.data;try{const m=re(n);self.postMessage({type:"success",results:m})}catch(m){self.postMessage({type:"error",error:m})}}})();
